<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebMIDI Switcher</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <script type="importmap">
    {
        "imports": {
            "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
            "vue-i18n": "https://unpkg.com/vue-i18n@11/dist/vue-i18n.esm-browser.js"
        }
    }
    </script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .connected { background: #2d5016; }
        .disconnected { background: #5d1e1e; }
        .tap-area {
            width: 100%;
            height: 200px;
            background: #333;
            border: 2px solid #666;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            margin: 20px 0;
            user-select: none;
            color: white;
            font-family: inherit;
            outline: none;
        }
        .tap-area:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        .tap-area.active {
            background: #4a5c2a;
            border-color: #8bc34a;
        }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .log-timestamp { 
            color: #888; 
            margin-right: 8px;
        }
        .log-source { 
            color: #4CAF50; 
            font-weight: bold; 
            margin-left: 8px;
            margin-right: 4px;
        }
        .log-arrow { 
            color: #FFF; 
            margin: 0 4px;
        }
        .log-destinations { 
            color: #2196F3; 
            margin-left: 4px;
        }
        .log-message { 
            color: #FF9800; 
            margin-right: 8px;
        }
        
        .notification {
            position: fixed;
            right: 20px;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            margin-bottom: 10px;
        }
        
        .notification.success {
            background: #4CAF50;
            top: 20px;
        }
        
        .notification.error {
            background: #f44336;
            top: 80px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        h3 {
            margin: 10px 0 5px 0;
            font-size: 16px;
        }
        
        .button-grid {
            display: flex;
            height: 100%;
            gap: 10px;
            padding: 10px;
        }
        
        .midi-button {
            flex: 1;
            background: #333;
            border: 2px solid #666;
            border-radius: 10px;
            color: white;
            font-family: inherit;
            cursor: pointer;
            user-select: none;
            outline: none;
            transition: all 0.1s ease;
            min-width: 0;
            font-weight: bold;
        }
        
        .midi-button.buttons-1 { font-size: clamp(32px, 8vw, 72px); }
        .midi-button.buttons-2 { font-size: clamp(24px, 6vw, 56px); }
        .midi-button.buttons-3 { font-size: clamp(20px, 5vw, 48px); }
        .midi-button.buttons-4 { font-size: clamp(18px, 4vw, 40px); }
        .midi-button.buttons-5, .midi-button.buttons-6, .midi-button.buttons-7, .midi-button.buttons-8,
        .midi-button.buttons-9, .midi-button.buttons-10, .midi-button.buttons-11, .midi-button.buttons-12,
        .midi-button.buttons-13, .midi-button.buttons-14, .midi-button.buttons-15, .midi-button.buttons-16 {
            font-size: clamp(14px, 2.5vw, 28px);
        }
        
        .midi-button:active,
        .midi-button.active {
            background: #4a5c2a;
            border-color: #8bc34a;
            transform: scale(0.95);
        }
        
        .midi-button:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        
        .tabs {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
            display: flex;
            height: 50px;
            flex-shrink: 0;
        }
        
        .tab-button {
            flex: 1;
            background: none;
            border: none;
            color: #888;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            padding: 10px;
        }
        
        .tab-button.active {
            color: #4CAF50;
            background: #333;
        }
        
        .view {
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        .main-view {
            display: flex;
            flex-direction: column;
        }
        
        .settings-view {
            overflow-y: auto;
            padding: 0 20px;
        }
        
        .midi-view {
            overflow-y: auto;
            padding: 0 20px;
        }
        
        .settings-section {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 10px;
        }
        
        .settings-section h3 {
            margin-top: 0;
        }
        
        .button-config {
            background: #444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .button-config label {
            display: block;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .button-config input,
        .button-config select {
            width: 100%;
            padding: 5px;
            margin-top: 3px;
            background: #555;
            border: 1px solid #666;
            color: white;
            border-radius: 4px;
        }
        
        .midi-message-list {
            background: #555;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
        
        .midi-message {
            background: #666;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 通知システム -->
        <div v-if="deviceChangeNotification" class="notification success">
            {{ deviceChangeNotification }}
        </div>
        <div v-if="errorNotification" class="notification error">
            {{ errorNotification }}
        </div>
        <div v-if="updateAvailable" class="notification success" style="top: 140px;">
            {{ $t('ui.update.available') }}
            <button @click="updateApp" style="margin-left: 10px; padding: 5px 10px; background: white; color: #4CAF50; border: none; border-radius: 3px;">
                {{ $t('ui.buttons.update') }}
            </button>
        </div>
        
        <div class="container">
            <!-- タブナビゲーション -->
            <div v-if="midiAccessAvailable" class="tabs">
                <button class="tab-button" :class="{ active: currentView === 'main' }" @click="currentView = 'main'">
                    {{ $t('ui.tabs.control') }}
                </button>
                <button class="tab-button" :class="{ active: currentView === 'settings' }" @click="currentView = 'settings'">
                    {{ $t('ui.tabs.settings') }}
                </button>
                <button class="tab-button" :class="{ active: currentView === 'midi' }" @click="currentView = 'midi'">
                    {{ $t('ui.tabs.midiHub') }}
                </button>
            </div>
            
            <div v-if="!midiAccessAvailable" style="text-align: center; padding: 20px;">
                <div :class="['status', 'disconnected']">
                    {{ $t('connection.status.disconnected') }}
                </div>
                <button @click="connectMIDI" style="margin-top: 10px;">
                    {{ $t('connection.button') }}
                </button>
            </div>

            <!-- メイン画面 -->
            <div v-show="currentView === 'main'" class="view main-view">
                <div v-if="midiAccessAvailable && midiConnected" style="position: absolute; top: 5px; right: 10px; font-size: 10px; opacity: 0.7; z-index: 10;">
                    {{ midiInputs.length }}in / {{ midiOutputs.length }}out
                </div>
                <div v-if="midiAccessAvailable" class="button-grid">
                    <button 
                        v-for="button in buttons" 
                        :key="button.id"
                        class="midi-button"
                        :class="[
                            { active: activeButtons.has(button.id) },
                            `buttons-${buttons.length}`
                        ]"
                        @mousedown="handleButtonPress(button.id)"
                        @mouseup="handleButtonRelease(button.id)"
                        @mouseleave="handleButtonRelease(button.id)"
                        @touchstart.prevent="handleButtonPress(button.id)"
                        @touchend.prevent="handleButtonRelease(button.id)"
                    >
                        {{ button.label }}
                    </button>
                </div>
            </div>

            <!-- 設定画面 -->
            <div v-show="currentView === 'settings'" class="view settings-view">
                <div class="settings-section">
                    <h3>{{ $t('ui.settings.buttonSettings') }}</h3>
                    
                    <div v-for="button in buttons" :key="button.id" class="button-config">
                        <label>
                            {{ $t('ui.settings.label') }}
                            <input type="text" v-model="button.label">
                        </label>
                        
                        <div style="margin: 10px 0;">
                            <strong>{{ $t('ui.settings.pressMessages') }}</strong>
                            <div class="midi-message-list">
                                <div v-for="(msg, i) in button.press" :key="i" class="midi-message" style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                                    <select @change="updateMidiMessage(button.id, 'press', i, 'type', $event.target.value)" :value="msg.type" style="width: auto; min-width: 80px;">
                                        <option value="cc">{{ $t('ui.midiTypes.cc') }}</option>
                                        <option value="note">{{ $t('ui.midiTypes.note') }}</option>
                                        <option value="program">{{ $t('ui.midiTypes.program') }}</option>
                                        <option value="pitch">{{ $t('ui.midiTypes.pitch') }}</option>
                                    </select>
                                    
                                    <label style="font-size: 11px;">Ch:
                                        <input type="number" min="0" max="15" :value="msg.channel" @input="updateMidiMessage(button.id, 'press', i, 'channel', $event.target.value)" style="width: 50px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'cc'" style="font-size: 11px;">CC:
                                        <input type="number" min="0" max="127" :value="msg.controller" @input="updateMidiMessage(button.id, 'press', i, 'controller', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'note'" style="font-size: 11px;">Note:
                                        <input type="number" min="0" max="127" :value="msg.note" @input="updateMidiMessage(button.id, 'press', i, 'note', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'program'" style="font-size: 11px;">Prog:
                                        <input type="number" min="0" max="127" :value="msg.program" @input="updateMidiMessage(button.id, 'press', i, 'program', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'cc' || msg.type === 'note'" style="font-size: 11px;">
                                        {{ msg.type === 'cc' ? 'Val:' : 'Vel:' }}
                                        <input type="number" min="0" max="127" :value="msg.type === 'cc' ? msg.value : msg.velocity" @input="updateMidiMessage(button.id, 'press', i, msg.type === 'cc' ? 'value' : 'velocity', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'pitch'" style="font-size: 11px;">Val:
                                        <input type="number" min="0" max="16383" :value="msg.value" @input="updateMidiMessage(button.id, 'press', i, 'value', $event.target.value)" style="width: 80px;">
                                    </label>
                                    
                                    <button @click="removeMidiMessage(button.id, 'press', i)" style="background: #d32f2f; border: none; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                        {{ $t('ui.buttons.removeMessage') }}
                                    </button>
                                </div>
                                <button @click="addMidiMessage(button.id, 'press')" style="background: #4CAF50; border: none; color: white; padding: 5px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px;">
                                    {{ $t('ui.buttons.addMessage') }}
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin: 10px 0;">
                            <strong>{{ $t('ui.settings.releaseMessages') }}</strong>
                            <div class="midi-message-list">
                                <div v-for="(msg, i) in button.release" :key="i" class="midi-message" style="display: flex; align-items: center; gap: 5px; flex-wrap: wrap;">
                                    <select @change="updateMidiMessage(button.id, 'release', i, 'type', $event.target.value)" :value="msg.type" style="width: auto; min-width: 80px;">
                                        <option value="cc">{{ $t('ui.midiTypes.cc') }}</option>
                                        <option value="note">{{ $t('ui.midiTypes.note') }}</option>
                                        <option value="program">{{ $t('ui.midiTypes.program') }}</option>
                                        <option value="pitch">{{ $t('ui.midiTypes.pitch') }}</option>
                                    </select>
                                    
                                    <label style="font-size: 11px;">Ch:
                                        <input type="number" min="0" max="15" :value="msg.channel" @input="updateMidiMessage(button.id, 'release', i, 'channel', $event.target.value)" style="width: 50px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'cc'" style="font-size: 11px;">CC:
                                        <input type="number" min="0" max="127" :value="msg.controller" @input="updateMidiMessage(button.id, 'release', i, 'controller', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'note'" style="font-size: 11px;">Note:
                                        <input type="number" min="0" max="127" :value="msg.note" @input="updateMidiMessage(button.id, 'release', i, 'note', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'program'" style="font-size: 11px;">Prog:
                                        <input type="number" min="0" max="127" :value="msg.program" @input="updateMidiMessage(button.id, 'release', i, 'program', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'cc' || msg.type === 'note'" style="font-size: 11px;">
                                        {{ msg.type === 'cc' ? 'Val:' : 'Vel:' }}
                                        <input type="number" min="0" max="127" :value="msg.type === 'cc' ? msg.value : msg.velocity" @input="updateMidiMessage(button.id, 'release', i, msg.type === 'cc' ? 'value' : 'velocity', $event.target.value)" style="width: 60px;">
                                    </label>
                                    
                                    <label v-if="msg.type === 'pitch'" style="font-size: 11px;">Val:
                                        <input type="number" min="0" max="16383" :value="msg.value" @input="updateMidiMessage(button.id, 'release', i, 'value', $event.target.value)" style="width: 80px;">
                                    </label>
                                    
                                    <button @click="removeMidiMessage(button.id, 'release', i)" style="background: #d32f2f; border: none; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                        {{ $t('ui.buttons.removeMessage') }}
                                    </button>
                                </div>
                                <button @click="addMidiMessage(button.id, 'release')" style="background: #4CAF50; border: none; color: white; padding: 5px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px;">
                                    {{ $t('ui.buttons.addMessage') }}
                                </button>
                            </div>
                        </div>
                        
                        <button @click="removeButton(button.id)" style="background: #d32f2f; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            {{ $t('ui.buttons.remove') }}
                        </button>
                    </div>
                    
                    <button @click="addButton" style="background: #4CAF50; border: none; color: white; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        {{ $t('ui.buttons.addButton') }}
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3>{{ $t('ui.settings.language') }}</h3>
                    <div style="margin: 10px 0;">
                        <select @change="changeLanguage($event.target.value)" :value="$i18n.locale" style="padding: 8px; background: #555; border: 1px solid #666; color: white; border-radius: 4px;">
                            <option value="ja">{{ $t('ui.languages.ja') }}</option>
                            <option value="en">{{ $t('ui.languages.en') }}</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>{{ $t('ui.settings.importExport') }}</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0;">
                        <button 
                            @click="exportSettings" 
                            style="background: #4CAF50; border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer;"
                        >
                            {{ $t('ui.buttons.export') }}
                        </button>
                        
                        <label style="background: #2196F3; border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                            {{ $t('ui.buttons.import') }}
                            <input type="file" accept=".json" @change="importSettings" style="display: none;">
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>{{ $t('ui.settings.otherSettings') }}</h3>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0;">
                        <button 
                            @click="requestWakeLock" 
                            :style="{ 
                                backgroundColor: wakeLockActive ? '#4CAF50' : '#666',
                                color: 'white',
                                border: 'none',
                                padding: '10px 15px',
                                borderRadius: '5px',
                                cursor: 'pointer'
                            }"
                        >
                            {{ wakeLockActive ? $t('controls.wakeLock.on') : $t('controls.wakeLock.off') }}
                        </button>
                        
                        <button 
                            v-if="midiAccessAvailable"
                            @click="disconnectMIDI" 
                            style="background: #d32f2f; border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer;"
                        >
                            {{ $t('ui.buttons.disconnect') }}
                        </button>
                        
                        <button 
                            @click="clearCache" 
                            style="background: #ff9800; border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer;"
                        >
                            {{ $t('ui.buttons.clearCache') }}
                        </button>
                    </div>
                    
                    <div v-if="swInfo.registered" style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                        <strong>{{ $t('ui.serviceWorker.info') }}</strong><br>
                        {{ $t('ui.serviceWorker.version') }} {{ swInfo.version }}<br>
                        {{ $t('ui.serviceWorker.mode') }} {{ swInfo.isDev ? 'Development' : 'Production' }}<br>
                        <span v-if="swInfo.isDev" style="color: #ff9800;">{{ $t('ui.serviceWorker.devWarning') }}</span>
                    </div>
                </div>
            </div>

            <!-- MIDIハブ画面 -->
            <div v-show="currentView === 'midi'" class="view midi-view">
                <div v-if="midiConnected && (inputDeviceNames.length > 0 || outputDeviceNames.length > 0)" style="margin: 10px 0; font-size: 12px;">
                    <strong>{{ $t('connection.deviceList.title') }}</strong>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                        <div>
                            <div style="font-weight: bold; color: #4CAF50; margin-bottom: 3px;">{{ $t('connection.deviceList.input.title', { count: inputDeviceNames.length }) }}</div>
                            <div v-for="name in inputDeviceNames" :key="'input-' + name" style="margin: 1px 0; padding-left: 10px; font-size: 11px;">
                                {{ name }}
                            </div>
                            <div v-if="inputDeviceNames.length === 0" style="color: #666; font-style: italic; padding-left: 10px; font-size: 11px;">
                                {{ $t('connection.deviceList.input.none') }}
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #2196F3; margin-bottom: 3px;">{{ $t('connection.deviceList.output.title', { count: outputDeviceNames.length }) }}</div>
                            <div v-for="name in outputDeviceNames" :key="'output-' + name" style="margin: 1px 0; padding-left: 10px; font-size: 11px;">
                                {{ name }}
                            </div>
                            <div v-if="outputDeviceNames.length === 0" style="color: #666; font-style: italic; padding-left: 10px; font-size: 11px;">
                                {{ $t('connection.deviceList.output.none') }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="midiConnected" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>{{ $t('log.title') }}</h3>
                        <button @click="clearLogs" style="padding: 5px 10px; font-size: 12px;">{{ $t('log.clearButton') }}</button>
                    </div>
                    <div id="midi-logs" style="background: #222; border: 1px solid #444; border-radius: 5px; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div v-if="midiLogs.length === 0" style="color: #666;">
                            {{ $t('log.waitingMessage') }}
                        </div>
                        <div v-for="log in midiLogs" :key="log.id" class="log-entry" style="margin: 2px 0; white-space: nowrap;">
                            <span class="log-timestamp">[{{ log.timestamp }}]</span>
                            <span class="log-message"> {{ log.message }}</span>
                            <span class="log-source">{{ log.source }}</span>
                            <span class="log-arrow"> → </span>
                            <span class="log-destinations">{{ log.destinations.join(', ') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
